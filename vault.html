<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Karma Credit â€“ Vault Info</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #09061c; color: #e5e2e4; font-family: 'Montserrat', Arial, sans-serif;}
    .card { background: linear-gradient(120deg, #0c0a0f 0%, #160f3d 100%);
            border: 1.7px solid #4b4181; border-radius: 1.15rem; margin-bottom: 2.1rem; }
    .gold { color: #8c84ac; }
    .menu-btn { position: fixed; top: 18px; left: 28px; z-index: 50; }
    .logout-absolute { position: fixed; top: 18px; right: 28px; z-index: 50; }
    .history-row { display: flex; justify-content: space-between; padding: 0.38rem 0.7em; border-bottom: 1px solid #333; }
    .history-row:last-child { border-bottom: none; }
  </style>
</head>
<body>
  <!-- Hamburger Menu Button -->
  <button id="menuBtn" class="menu-btn bg-[#16122f] p-2 rounded-full border border-[#4b4181] hover:bg-[#4b4181]">
    <svg width="30" height="30" fill="none" stroke="#e5e2e4" stroke-width="3" viewBox="0 0 24 24">
      <path stroke-linecap="round" d="M4 7h16M4 12h16M4 17h16"/></svg>
  </button>
  <!-- Logout -->
  <button id="logoutBtn" class="btn-primary logout-absolute">Logout</button>
  <!-- Main Container -->
  <div class="w-full max-w-2xl mx-auto mt-12 p-6">
    <!-- Clickable logo/title -->
    <a href="dashboard.html">
      <img src="https://i.postimg.cc/KcLVGFWY/logo6.png" class="logo-img w-20 h-20 rounded-full mx-auto mb-2"/>
      <img src="https://i.postimg.cc/QtFmLjWh/logo8.png" class="title-img max-w-xs mx-auto mb-6"/>
    </a>
    <div class="card p-7 mb-8">
      <h1 class="text-2xl gold font-bold mb-3">Vault Info</h1>
      <div id="vaultInfo">
        <div class="text-lg mb-2">Vault ID: <span id="vaultId"></span></div>
        <div class="text-xl font-bold mb-2">Balance: $<span id="vaultBalance"></span></div>
        <div>Interest Rate: <span id="interestRate"></span>% <span id="nextInterest"></span></div>
      </div>
    </div>
    <div class="card p-7 mb-8">
      <h2 class="text-xl gold font-semibold mb-3">Transaction History</h2>
      <canvas id="vaultChart" height="120"></canvas>
      <div id="vaultHistory" class="mt-4"></div>
    </div>
    <a href="dashboard.html" class="text-blue-300 hover:underline">&larr; Back to Summary</a>
  </div>
  <script>
    // Supabase config (from your dashboard)
    const db = supabase.createClient(
      "https://nxgivpbbuwbzjsfbhlzt.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54Z2l2cGJidXdiempzZmJobHp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3ODA2ODYsImV4cCI6MjA2NDM1NjY4Nn0.7Hrn29OfpNGLyOy3tASiuWX6lsWQ3t1mrLWBb2K_E7E"
    );

    // Session handling
    const raw = localStorage.getItem("karmaUser");
    if (!raw) { window.location.href = "index.html"; }
    const user = JSON.parse(raw);

    document.getElementById('logoutBtn').onclick = function() {
      localStorage.removeItem("karmaUser");
      window.location.href = "index.html";
    };

    // Fetch and display vault info & history
    async function loadVault() {
      if (!user.vault_id) {
        document.getElementById('vaultInfo').innerHTML = '<div class="text-pink-300">No vault account found.</div>';
        return;
      }
      document.getElementById("vaultId").textContent = user.vault_id;

      // Get all vault transactions
      const { data: txns, error } = await db
        .from("vault_transactions")
        .select("*")
        .eq("user_id", user.id)
        .order("date", { ascending: true });
      if (error || !txns.length) {
        document.getElementById("vaultBalance").textContent = "0";
        document.getElementById("vaultHistory").innerHTML = "<div>No transactions found.</div>";
        return;
      }

      // Calculate balance, interest rate, next payout
      let balance = 0;
      let chartLabels = [], chartData = [];
      txns.forEach(t => {
        balance += t.amount;
        chartLabels.push(t.date);
        chartData.push(balance);
      });
      document.getElementById("vaultBalance").textContent = balance.toLocaleString();

      // Interest rate logic (from dashboard)
      function parseLocalDate(iso) {
        const [y, m, d] = iso.split("-").map(Number);
        return new Date(Date.UTC(y, m - 1, d));
      }
      function rateForWeek(weekNo) {
        if (weekNo < 2) return 0.5;
        if (weekNo < 6) return 1.0;
        if (weekNo < 10) return 1.5;
        return 2.0;
      }
      // Find oldest deposit date
      const firstDeposit = parseLocalDate(txns[0].date);
      const today = new Date();
      const msPerDay = 1000 * 60 * 60 * 24;
      const diffDays = Math.floor((today - firstDeposit) / msPerDay);
      const weekNo = Math.floor(diffDays / 7);
      const curRate = rateForWeek(weekNo);
      document.getElementById("interestRate").textContent = curRate.toFixed(2);

      // Next interest payout
      const nextInterest = new Date(firstDeposit.getTime() + ((weekNo + 1) * 7 * msPerDay));
      document.getElementById("nextInterest").textContent = `(Next: ${nextInterest.toISOString().slice(0,10)})`;

      // Chart
      const ctx = document.getElementById('vaultChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartLabels,
          datasets: [{ label: 'Balance', data: chartData, fill: false }]
        },
        options: { responsive: true, plugins: { legend: { display: false } } }
      });

      // History list
      let hist = "";
      txns.slice().reverse().forEach(t => {
        hist += `<div class="history-row"><span>${t.date}</span><span class="${t.amount >= 0 ? 'text-green-300' : 'text-pink-300'}">${t.amount >= 0 ? "+" : ""}${t.amount}</span></div>`;
      });
      document.getElementById("vaultHistory").innerHTML = hist;
    }

    loadVault();
  </script>
</body>
</html>
