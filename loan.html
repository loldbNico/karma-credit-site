<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Karma Credit – Loan Info</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { background: #09061c; color: #e5e2e4; font-family: 'Montserrat', Arial, sans-serif;}
    .card { background: linear-gradient(120deg, #0c0a0f 0%, #160f3d 100%);
            border: 1.7px solid #4b4181; border-radius: 1.15rem; margin-bottom: 2.1rem; }
    .gold { color: #8c84ac; }
    .menu-btn { position: fixed; top: 18px; left: 28px; z-index: 50; }
    .logout-absolute { position: fixed; top: 18px; right: 28px; z-index: 50; }
    .installment-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 0.4em 0; }
    .installment-row:last-child { border-bottom: none; }
  </style>
</head>
<body>
  <button id="menuBtn" class="menu-btn bg-[#16122f] p-2 rounded-full border border-[#4b4181] hover:bg-[#4b4181]">
    <svg width="30" height="30" fill="none" stroke="#e5e2e4" stroke-width="3" viewBox="0 0 24 24">
      <path stroke-linecap="round" d="M4 7h16M4 12h16M4 17h16"/></svg>
  </button>
  <button id="logoutBtn" class="btn-primary logout-absolute">Logout</button>
  <div class="w-full max-w-2xl mx-auto mt-12 p-6">
    <a href="dashboard.html">
      <img src="https://i.postimg.cc/KcLVGFWY/logo6.png" class="logo-img w-20 h-20 rounded-full mx-auto mb-2"/>
      <img src="https://i.postimg.cc/QtFmLjWh/logo8.png" class="title-img max-w-xs mx-auto mb-6"/>
    </a>
    <div class="card p-7 mb-8">
      <h1 class="text-2xl gold font-bold mb-3">Loan Info</h1>
      <div id="loanInfo">
        <div>Loan ID: <span id="loanId"></span></div>
        <div>Signed on: <span id="loanStart"></span></div>
        <div>Amount: $<span id="loanAmount"></span></div>
        <div>Interest Rate: <span id="loanInterest"></span>%</div>
        <div>Installments: <span id="installments"></span></div>
        <div>Status: <span id="loanStatus"></span></div>
      </div>
    </div>
    <div class="card p-7 mb-8">
      <h2 class="text-xl gold font-semibold mb-3">Installment Schedule</h2>
      <div id="installmentList"></div>
    </div>
    <a href="dashboard.html" class="text-blue-300 hover:underline">&larr; Back to Summary</a>
  </div>
  <script>
    const db = supabase.createClient(
      "https://nxgivpbbuwbzjsfbhlzt.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54Z2l2cGJidXdiempzZmJobHp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3ODA2ODYsImV4cCI6MjA2NDM1NjY4Nn0.7Hrn29OfpNGLyOy3tASiuWX6lsWQ3t1mrLWBb2K_E7E"
    );
    const raw = localStorage.getItem("karmaUser");
    if (!raw) { window.location.href = "index.html"; }
    const user = JSON.parse(raw);

    document.getElementById('logoutBtn').onclick = function() {
      localStorage.removeItem("karmaUser");
      window.location.href = "index.html";
    };

    async function loadLoan() {
      if (!user.loan_id) {
        document.getElementById('loanInfo').innerHTML = '<div class="text-pink-300">No active loan found.</div>';
        return;
      }
      document.getElementById("loanId").textContent = user.loan_id || "—";
      document.getElementById("loanStart").textContent = user.loan_start || "—";
      document.getElementById("loanAmount").textContent = user.loan_amount ? user.loan_amount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) : "0.00";
      document.getElementById("loanInterest").textContent = user.loan_interest_rate != null ? user.loan_interest_rate : "—";
      document.getElementById("installments").textContent = user.installment_count != null ? user.installment_count : "—";

      // Fetch installments
      const { data: insts, error } = await db
        .from("loan_installments")
        .select("*")
        .eq("user_id", user.id)
        .eq("loan_id", user.loan_id)
        .order("installment_no", { ascending: true });
      let status = "—";
      if (!insts || !insts.length) {
        document.getElementById("installmentList").innerHTML = "<div>No installments found.</div>";
        status = "No installments";
      } else {
        let html = "";
        insts.forEach(inst => {
          html += `<div class="installment-row ${inst.status === 'Paid' ? 'text-green-400' : inst.status === 'Overdue' ? 'text-pink-400' : ''}">
            <span>#${inst.installment_no}</span>
            <span>${inst.due_date}</span>
            <span>$${(+inst.payment_amt).toFixed(2)}</span>
            <span>${inst.status}</span>
          </div>`;
        });
        document.getElementById("installmentList").innerHTML = html;

        const next = insts.find(i => i.status === "Pending");
        if (!next) status = "Fulfilled";
        else {
          const due = new Date(next.due_date + "T00:00:00Z");
          status = due < new Date() ? "Overdue" : "Upcoming";
        }
      }
      document.getElementById("loanStatus").textContent = status;
    }
    loadLoan();
  </script>
</body>
</html>
