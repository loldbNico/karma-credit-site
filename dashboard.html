<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Karma Credit – Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;900&display=swap" rel="stylesheet">
  <style>
    body {
      min-height: 100vh;
      margin: 0;
      background: radial-gradient(ellipse at 60% 18%, #1f1362 0%, #05030a 60%, #000000 100%);
      color: #e5e2e4;
      font-family: 'Montserrat', 'Roboto', Arial, sans-serif;
      position: relative;
      overflow-x: hidden;
    }
    .starfield {
      pointer-events: none;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      z-index: 0;
    }
    .logo-img {
      display: block;
      margin: 0 auto 1em auto;
      width: 82px; height: 82px;
      border-radius: 50%;
      box-shadow: 0 0 18px 6px #00000088;
      object-fit: cover;
      background: #000000;
    }
    .title-img {
      max-width: 280px;
      width: 95%;
      display: block;
      margin-left: auto;
      margin-right: auto;
      margin-bottom: 1rem;
    }
    .logout-absolute {
      position: fixed;
      top: 18px;
      right: 28px;
      z-index: 50;
    }
    @media (max-width: 640px) {
      .logout-absolute { top: 6px; right: 5vw; }
      .logo-img { width: 56px; height: 56px; }
      .title-img { max-width: 150px; }
      .card { padding: 1.2rem 0.6rem; }
      #calendarContainer { flex-direction: column !important; gap: 1.2rem !important; }
      .month-container { min-width: 0; max-width: 100vw; width: 100%; }
    }
    .fancy-bank-title { display: none; }
    .card {
      background: linear-gradient(120deg, #0c0a0f 0%, #160f3d 100%);
      border: 1.7px solid #4b4181;
      box-shadow: 0 6px 28px 0 #000c, 0 1.5px 16px 0 #23176566;
      border-radius: 1.15rem;
      backdrop-filter: blur(6px);
      margin-bottom: 2.1rem;
      transition: box-shadow 0.18s, border-color 0.18s;
      padding: 2rem 1.5rem;
    }
    .card:last-child { margin-bottom: 0; }
    .gold { color: #8c84ac; }
    .balance-highlight {
      font-size: 2.1rem;
      font-weight: 800;
      letter-spacing: 0.03em;
      color: #e5e2e4;
      background: linear-gradient(90deg, #4b4181 0%, #8c84ac 100%);
      border-radius: 0.8em;
      box-shadow: 0 0 16px 3px #5f568f44;
      display: inline-block;
      padding: 0.16em 0.8em;
      margin: 0.13em 0 0.08em 0;
      border: 2px solid #9993b4;
      text-shadow: 0 1px 4px #4b418155;
    }
    .score-bar {
      height: 1.1rem;
      border-radius: 0.4rem;
      background: linear-gradient(90deg, #9993b4 0%, #8c84ac 100%);
      background-size: 200% 100%;
      margin-top: 0.5em;
      margin-bottom: 0.35em;
    }
    .score-value {
      position: relative;
      font-size: 1rem;
      text-align: center;
      color: #fff;
      margin-top: -0.6em;
      margin-bottom: 0.4em;
      font-weight: bold;
      text-shadow: 0 1px 2px #111c;
    }
    .calendar-cell {
      width: 38px;
      height: 38px;
      border: 1.3px solid #4b4181;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin: 2px;
      box-sizing: border-box;
      font-size: 0.98rem;
      background-color: transparent;
      color: #e5e2e4;
      border-radius: 0.5em;
      font-family: 'Montserrat', 'Roboto', Arial, sans-serif;
      transition: background 0.18s, color 0.18s;
      z-index: 2;
      position: relative;
    }
    td.installment {
      background: #a993fc !important;
      color: #231765 !important;
      font-weight: 900;
      border-radius: 0.5em;
      border: 2px solid #9e75f9 !important;
    }
    td.interest-increase {
      border: 2.5px solid #5dc7fa !important;
      color: #82d6ff;
      font-weight: 700;
      background: #19235d !important;
    }
    td.both {
      background: #a7e0f9 !important;
      color: #0c253b !important;
      border: 2.5px solid #8c84ac !important;
      font-weight: 900;
      border-radius: 0.5em;
      box-shadow: 0 0 8px #73ccff44;
    }
    td.today {
      background: #ffe881 !important;
      color: #1e1609 !important;
      font-weight: 900;
      border-radius: 0.5em;
      border: 3px solid #e2b500 !important;
      box-shadow: 0 0 16px 5px #fff5be77, 0 0 8px 1px #ffd53a77;
      animation: pulse-today 1.2s infinite alternate;
    }
    @keyframes pulse-today {
      from { box-shadow: 0 0 16px 5px #fff5be77, 0 0 8px 1px #ffd53a77; }
      to   { box-shadow: 0 0 22px 10px #fff9cd99, 0 0 12px 2px #ffe25a99; }
    }
    .month-header {
      text-align: center; font-size: 1.08rem;
      margin-bottom: 0.3rem; color: #e5e2e4;
      letter-spacing: 0.06em;
      font-weight: 700;
    }
    .calendar-table th {
      font-size: 0.85rem !important;
      font-weight: 700;
      color: #aaa9b7;
      padding: 0.33em 0;
      background: transparent;
    }
    #calendarContainer {
      display: flex;
      flex-direction: row;
      gap: 2rem;
      justify-content: center;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .month-container {
      min-width: 320px;
      max-width: 340px;
      flex: 1 1 320px;
      background: #1c1844;
      border: 2.5px solid #534f8d;
      border-radius: 1.2rem;
      box-shadow: 0 6px 30px 0 #000c, 0 1.5px 16px 0 #23176566;
      padding: 1.2rem 1.1rem 1rem 1.1rem;
      margin: 0;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body class="relative min-h-screen pt-3 pb-6 px-1 sm:px-0 flex flex-col items-center">
  <canvas class="starfield" id="starfield"></canvas>
  <!-- LOGOUT BUTTON, always in top-right -->
  <button id="logoutBtn" class="btn-primary logout-absolute">Logout</button>
  <div class="w-full max-w-2xl z-10 relative">
    <img src="https://i.postimg.cc/KcLVGFWY/logo6.png" alt="Karma Credit Logo" class="logo-img mt-4">
    <!-- Title as an image, not text -->
    <img src="https://i.postimg.cc/QtFmLjWh/logo8.png" alt="Karma Credit" class="title-img">
    <div id="feedbackMsg" class="mb-2 text-center text-base"></div>
    <div class="card p-6 mb-6">
      <h2 class="text-2xl gold font-semibold mb-4">User Info</h2>
      <div class="grid grid-cols-2 gap-x-4 gap-y-2 mb-2">
        <div class="text-label">Client Name:</div>
        <div id="dispFullName" class="pl-1"></div>
        <div class="text-label">State ID:</div>
        <div id="dispID" class="pl-1"></div>
        <div class="text-label">Phone:</div>
        <div id="dispPhone" class="pl-1"></div>
        <div class="text-label">Credit Score:</div>
        <div id="dispCreditScore" class="pl-1"></div>
      </div>
      <div class="mt-2">
        <div class="score-bar" id="scoreBar"></div>
        <div class="score-value" id="scoreValue"></div>
      </div>
    </div>
    <div id="vaultCard" class="card p-6 mb-6">
      <h2 class="text-2xl gold font-semibold mb-4">
        Vault ID: <span id="dispVaultID"></span>
      </h2>
      <div><span id="dispVaultBalance" class=""></span></div>
      <p>
        <span class="text-label">Current Weekly Interest Rate:</span>
        <span id="dispInterestRate"></span>%
        <span id="nextInterestMsg" style="font-size: 0.92rem; color: #8c84ac;"></span>
      </p>
      <h3 class="text-xl gold font-semibold mt-6 mb-2">History</h3>
      <div id="historyList"></div>
    </div>
    <div id="vaultInvite" class="card p-6 mb-6 hidden text-center">
      <h2 class="text-2xl gold font-semibold mb-4">No Vault Found</h2>
      <p>
        You don’t have a vault with Karma Credit yet.<br>
        Entrust your funds with us for safety and earn weekly interest.<br>
        <a href="create_vault.html" class="text-label underline hover:text-blue-100">Open a Vault Now →</a>
      </p>
    </div>
    <div id="loanCard" class="card p-6 mb-6">
      <h2 class="text-2xl gold font-semibold mb-4">
        Loan ID: <span id="dispLoanID"></span> signed on <span id="dispLoanStart"></span>
      </h2>
      <div class="grid grid-cols-2 gap-x-3 gap-y-1">
        <div class="text-label">Amount Loaned Out:</div>
        <div>$<span id="dispLoanAmount"></span></div>
        <div class="text-label">Weekly Interest Rate:</div>
        <div><span id="dispLoanInterestRate"></span>%</div>
        <div class="text-label">Number of Installments:</div>
        <div><span id="dispInstallmentCount"></span></div>
        <div class="text-label">Next Payment Amount:</div>
        <div>$<span id="dispNextPaymentAmt"></span> on <span id="dispNextPaymentDate"></span></div>
        <div class="text-label">Status:</div>
        <div><span id="dispLoanStatus"></span></div>
      </div>
    </div>
    <div id="loanInvite" class="card p-6 mb-6 hidden text-center">
      <h2 class="text-2xl gold font-semibold mb-4">No Active Loan</h2>
      <p>
        You don’t have a loan with Karma Credit yet.<br>
        Reach out to apply for a loan and enjoy flexible repayment terms.<br>
        <a href="apply_loan.html" class="text-label underline hover:text-blue-100">Apply for a Loan →</a>
      </p>
    </div>
    <div class="card p-6">
      <h2 class="text-2xl gold font-semibold mb-4">User Calendar</h2>
      <div id="calendarLegend" class="mb-2 text-base">
        <span class="px-2" style="background-color: #a993fc; color: #231765; border-radius:0.4em; font-weight:900;">Upcoming Installment</span>
        <span class="px-2 ml-2" style="border: 2px solid #5dc7fa; border-radius:0.4em; color: #5dc7fa;">Interest Payment</span>
        <span class="px-2 ml-2" style="background-color: #ffe881; color: #231765; border-radius:0.4em; border:2px solid #e2b500;">Today</span>
      </div>
      <div id="calendarContainer"></div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // Starfield effect (unchanged)
    const starColors = ["#e5e2e4", "#8c84ac", "#5f568f", "#ffffff"];
    const canvas = document.getElementById("starfield");
    const ctx = canvas.getContext("2d");
    let w, h, stars = [];
    function resize() { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize);
    function initStars() {
      stars = [];
      for (let i = 0; i < 140; i++) {
        stars.push({
          x: Math.random() * w,
          y: Math.random() * h,
          r: Math.random() * 0.85 + 0.3,
          alpha: Math.random() * 0.6 + 0.13,
          tw: Math.random() * 2 * Math.PI,
          c: starColors[Math.floor(Math.random() * starColors.length)]
        });
      }
    }
    function animateStars() {
      ctx.clearRect(0, 0, w, h);
      for (let s of stars) {
        ctx.save();
        ctx.globalAlpha = Math.abs(Math.sin(performance.now()/900 + s.tw)) * s.alpha + 0.08;
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r, 0, 2 * Math.PI);
        ctx.fillStyle = s.c;
        ctx.shadowColor = s.c;
        ctx.shadowBlur = 12;
        ctx.fill();
        ctx.restore();
      }
      requestAnimationFrame(animateStars);
    }
    resize(); initStars(); animateStars();
    window.addEventListener('resize', () => { resize(); initStars(); });

    // Dashboard user state
    const db = supabase.createClient(
      "https://nxgivpbbuwbzjsfbhlzt.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54Z2l2cGJidXdiempzZmJobHp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3ODA2ODYsImV4cCI6MjA2NDM1NjY4Nn0.7Hrn29OfpNGLyOy3tASiuWX6lsWQ3t1mrLWBb2K_E7E"
    );
    const raw = localStorage.getItem("karmaUser");
    if (!raw) {
      alert("No user data found. Please log in again.");
      window.location.href = "index.html";
    }
    const user = JSON.parse(raw);
    document.getElementById("dispFullName").textContent = user.full_name || "—";
    document.getElementById("dispID").textContent = user.id || "—";
    document.getElementById("dispPhone").textContent = user.phone || "—";
    const cs = user.credit_score != null ? user.credit_score : 0;
    document.getElementById("dispCreditScore").textContent = `${cs}/100`;
    const scoreBar = document.getElementById("scoreBar");
    let pos = cs * 2 - 100;
    scoreBar.style.backgroundPosition = `${pos}% 0`;
    document.getElementById("scoreValue").textContent = `${cs}/100`;
    document.getElementById("logoutBtn").onclick = function() {
      localStorage.removeItem("karmaUser");
      window.location.href = "index.html";
    };

    // Calendar & history helpers
    function parseLocalDate(iso) {
      const [y, m, d] = iso.split("-").map(Number);
      return new Date(Date.UTC(y, m - 1, d));
    }
    function getInterestResetEvents(txns) {
      let resets = [];
      txns = [...txns].sort((a, b) => (a.date < b.date ? -1 : 1));
      for (let i = 0; i < txns.length; i++) {
        const t = txns[i];
        const tDate = parseLocalDate(t.date);
        if (t.amount < 0) {
          let balBefore = 0;
          for (let j = 0; j < i; j++) { balBefore += txns[j].amount; }
          if (Math.abs(t.amount) > 0.25 * balBefore) {
            resets.push({ date: tDate, iso: t.date, balBefore, withdrawal: t.amount });
          }
        }
      }
      return resets;
    }
    function rateForWeek(weekNo) {
      if (weekNo < 2) return 0.0025;
      if (weekNo < 4) return 0.005;
      if (weekNo < 6) return 0.0075;
      return 0.01;
    }
    // --- Core Calendar Builder ---
    async function buildCalendar() {
      const container = document.getElementById("calendarContainer");
      container.innerHTML = "";
      // Loan installments (pending/overdue only)
      let instISOs = [];
      if (user.loan_id) {
        const { data: insts, error } = await db
          .from("loan_installments")
          .select("due_date, status")
          .eq("user_id", user.id)
          .eq("loan_id", user.loan_id);
        if (!error && insts) {
          instISOs = insts.filter(i => i.status !== "Paid").map(i => i.due_date);
        }
      }
      // Vault interest payout dates, 2 months into future
      let vaultInterestISOs = [];
      if (user.vault_id) {
        const txnsRes = await db
          .from("vault_transactions")
          .select("date, amount")
          .eq("user_id", user.id)
          .order("date", { ascending: true });
        const txns = txnsRes.data || [];
        if (txns.length) {
          let firstDepositDate = parseLocalDate(txns[0].date);
          const resets = getInterestResetEvents(txns);
          let allResetPoints = [firstDepositDate, ...resets.map(r => r.date)];
          let periodEnds = resets.map(r => r.date);
          periodEnds.push(new Date(Date.now() + 61 * 24 * 60 * 60 * 1000));
          let payoutDates = [];
          for (let p = 0; p < allResetPoints.length; p++) {
            let d = new Date(allResetPoints[p].getTime());
            while (d < periodEnds[p]) {
              d = new Date(d.getTime() + 7 * 24 * 60 * 60 * 1000);
              if (d > periodEnds[p]) break;
              payoutDates.push(d.toISOString().slice(0, 10));
            }
          }
          // Add future payouts up to 2 months ahead
          let maxFuture = new Date(Date.now() + 61 * 24 * 60 * 60 * 1000);
          let last = new Date(txns[txns.length - 1].date);
          while (last < maxFuture) {
            last = new Date(last.getTime() + 7 * 24 * 60 * 60 * 1000);
            if (last > maxFuture) break;
            payoutDates.push(last.toISOString().slice(0, 10));
          }
          vaultInterestISOs = Array.from(new Set(payoutDates)); // Remove dups
        }
      }
      // Only 2 months: current + next (UTC logic)
      const today = new Date();
      let months = [
        { m: today.getUTCMonth(), y: today.getUTCFullYear() },
        { m: (today.getUTCMonth() + 1) % 12, y: (today.getUTCMonth() === 11 ? today.getUTCFullYear() + 1 : today.getUTCFullYear()) }
      ];
      function createMonthGrid(m, y) {
        const monthName = new Date(Date.UTC(y, m)).toLocaleString("default", { month: "long" });
        const wrapper = document.createElement("div");
        wrapper.className = "month-container";
        const title = document.createElement("div");
        title.className = "month-header";
        title.textContent = `${monthName} ${y}`;
        wrapper.appendChild(title);
        const table = document.createElement("table");
        table.className = "calendar-table";
        const thead = document.createElement("thead");
        const daysRow = document.createElement("tr");
        ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].forEach((d) => {
          const th = document.createElement("th");
          th.textContent = d;
          daysRow.appendChild(th);
        });
        thead.appendChild(daysRow);
        table.appendChild(thead);
        const tbody = document.createElement("tbody");
        // Always 6x7 grid, UTC logic
        const firstOfMonth = new Date(Date.UTC(y, m, 1));
        const startDay = firstOfMonth.getUTCDay();
        const gridStart = new Date(Date.UTC(y, m, 1 - startDay));
        for (let row = 0; row < 6; row++) {
          const tr = document.createElement("tr");
          for (let col = 0; col < 7; col++) {
            const cell = document.createElement("td");
            cell.className = "calendar-cell";
            // This cell's date
            const cellDate = new Date(gridStart.getTime() + (row * 7 + col) * 24 * 60 * 60 * 1000);
            const cellY = cellDate.getUTCFullYear();
            const cellM = cellDate.getUTCMonth();
            const cellD = cellDate.getUTCDate();
            cell.textContent = cellD;
            const iso = cellDate.toISOString().slice(0, 10);
            if (cellM !== m) cell.style.opacity = "0.38";
            // Today highlight (UTC)
            const now = new Date();
            const todayIso = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate())).toISOString().slice(0,10);
            if (iso === todayIso) cell.classList.add("today");
            // Installment (unpaid)
            if (instISOs.includes(iso)) {
              cell.classList.add("installment");
              cell.title = `Upcoming Loan Installment`;
            }
            // Interest (future included)
            if (vaultInterestISOs.includes(iso)) {
              if (cell.classList.contains("installment")) {
                cell.classList.remove("installment");
                cell.classList.add("both");
                cell.title = `Installment + Vault Interest Deposit`;
              } else {
                cell.classList.add("interest-increase");
                cell.title = `Vault Interest Deposit`;
              }
            }
            tr.appendChild(cell);
          }
          tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        wrapper.appendChild(table);
        return wrapper;
      }
      for (let mobj of months) {
        container.appendChild(createMonthGrid(mobj.m, mobj.y));
      }
    }
    buildCalendar();


    // ----------- Vault History Logic: Interest payouts only up to today! -----------
    async function computeAndDisplayVaultBalance() {
      const txnsRes = await db
        .from("vault_transactions")
        .select("*")
        .eq("user_id", user.id)
        .order("date", { ascending: true });
      if (txnsRes.error || !txnsRes.data.length) {
        document.getElementById("dispVaultBalance").textContent = "$ 0";
        document.getElementById("dispVaultBalance").className = "";
        document.getElementById("dispInterestRate").textContent = "0";
        document.getElementById("nextInterestMsg").textContent = "";
        document.getElementById("historyList").innerHTML = "";
        let toggleBtn = document.getElementById("historyToggleBtn");
        if (toggleBtn) toggleBtn.style.display = "none";
        showFeedback("No vault transactions found.", true);
        return;
      }
      let txns = txnsRes.data;
      txns = txns.sort((a, b) => (a.date < b.date ? -1 : 1));
      const firstDepositDate = parseLocalDate(txns[0].date);
      const today = new Date();
      const resets = getInterestResetEvents(txns);

      // Only up to today for history
      let payoutDates = [];
      let allResetPoints = [{date: firstDepositDate, iso: txns[0].date}, ...resets.map(r => ({date: r.date, iso: r.iso}))];
      for (let i = 0; i < allResetPoints.length; i++) {
        let start = allResetPoints[i].date;
        let end = (i + 1 < allResetPoints.length) ? allResetPoints[i + 1].date : today;
        let theseDates = getInterestPayoutDates(start, end);
        payoutDates = payoutDates.concat(theseDates);
      }

      let allEvents = [];
      for (const t of txns) {
        allEvents.push({
          type: "txn", date: parseLocalDate(t.date), iso: t.date, amount: t.amount, resetTriggered: false
        });
      }
      payoutDates.forEach((payoutDate, idx) => {
        let resetIdx = -1;
        for (let i = allResetPoints.length - 1; i >= 0; i--) {
          if (allResetPoints[i].date <= payoutDate) {
            resetIdx = i;
            break;
          }
        }
        let lastResetDate = allResetPoints[resetIdx].date;
        const msPerDay = 1000 * 60 * 60 * 24;
        const weekNo = Math.floor((payoutDate - lastResetDate) / (7 * msPerDay));
        const rate = rateForWeek(weekNo);
        let bal = 0;
        allEvents.filter(e => e.date < payoutDate).sort((a, b) => a.date - b.date).forEach(e => { bal += e.amount; });
        if (bal > 0) {
          const interestAmt = Math.floor(bal * rate);
          if (interestAmt > 0) {
            allEvents.push({
              type: "interest",
              date: new Date(payoutDate),
              iso: payoutDate.toISOString().slice(0, 10),
              amount: interestAmt,
              interestNum: idx + 1
            });
          }
        }
      });
      for (let r of resets) {
        let evt = allEvents.find(e =>
          e.type === "txn" && e.amount < 0 && e.date.getTime() === r.date.getTime()
        );
        if (evt) evt.resetTriggered = true;
      }
      allEvents.sort((a, b) => b.date - a.date);
      let finalBalance = 0;
      [...allEvents].sort((a, b) => a.date - b.date).forEach(evt => { finalBalance += evt.amount; });
      let balanceEl = document.getElementById("dispVaultBalance");
      balanceEl.textContent = "$ " + finalBalance.toLocaleString(undefined, { maximumFractionDigits: 0 });
      balanceEl.className = "balance-highlight";
      showFeedback("Vault balance updated.");
      let lastResetDate = getLastResetDate(resets, today, firstDepositDate);
      const weeksSinceReset = Math.floor((today - lastResetDate) / (7 * 1000 * 60 * 60 * 24));
      const curRate = rateForWeek(weeksSinceReset) * 100;
      document.getElementById("dispInterestRate").textContent = curRate.toFixed(2);
      document.getElementById("nextInterestMsg").textContent = ` (${nextInterestInfo(lastResetDate)})`;
      loadVaultHistoryUI(allEvents, false);
    }

    function loadVaultHistoryUI(allEvents, showAll = false) {
      allEvents = [...allEvents].sort((a, b) => b.date - a.date);
      const oldestDeposit = [...allEvents]
        .filter(e => e.type === "txn" && e.amount > 0)
        .sort((a, b) => a.date - b.date)[0];
      let displayEvents = showAll ? allEvents : allEvents.slice(0, 6);
      const histContainer = document.getElementById("historyList");
      histContainer.innerHTML = "";
      displayEvents.forEach(evt => {
        let label = "", highlight = false;
        if (evt.type === "txn") {
          if (evt.amount > 0) {
            label = (oldestDeposit && evt.iso === oldestDeposit.iso) ? "Founding Deposit" : "Deposit";
            highlight = true;
          } else { label = "Withdrawal"; highlight = true; }
        } else if (evt.type === "interest") {
          label = `Interest Payout #${evt.interestNum}`;
        }
        const row = document.createElement("div");
        row.className = "history-row";
        if (highlight) {
          row.style.background = "#2c2251";
          row.style.fontWeight = "bold";
          row.style.fontSize = "1.06rem";
          row.style.boxShadow = "0 0 3px #b48fff88";
          row.style.border = "1.5px solid #b48fff99";
        } else {
          row.style.opacity = "0.92";
          row.style.fontSize = "0.97rem";
        }
        const leftCol = document.createElement("div");
        leftCol.innerHTML = `<span style="min-width: 90px; display: inline-block;">${evt.iso}</span>
                             <span style="margin-left:0.7em; color:${highlight ? "#b48fff" : "#aaa"}">${label}</span>`;
        const amountSpan = document.createElement("span");
        amountSpan.textContent = evt.amount.toLocaleString(undefined, {
          style: "currency",
          currency: "USD",
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });
        if (evt.type === "txn") {
          amountSpan.style.color = evt.amount < 0 ? "#fc657c" : "#63ebff";
        } else {
          amountSpan.style.color = "#63ebff";
        }
        amountSpan.style.fontWeight = highlight ? "bold" : "normal";
        amountSpan.style.fontSize = highlight ? "1.06rem" : "0.97rem";
        row.appendChild(leftCol);
        row.appendChild(amountSpan);
        histContainer.appendChild(row);
      });
      let toggleBtn = document.getElementById("historyToggleBtn");
      if (!toggleBtn) {
        toggleBtn = document.createElement("button");
        toggleBtn.id = "historyToggleBtn";
        toggleBtn.className = "mt-3 btn-primary";
        histContainer.after(toggleBtn);
      }
      toggleBtn.textContent = showAll ? "Show Only Latest 6" : "Show All Transactions";
      toggleBtn.onclick = () => loadVaultHistoryUI(allEvents, !showAll);
      toggleBtn.style.display = allEvents.length <= 6 ? "none" : "";
    }
  </script>
</body>
</html>
