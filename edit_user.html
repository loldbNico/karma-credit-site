<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Karma Credit â€“ Edit User</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body { background: #09061c; color: #e5e2e4; font-family: 'Montserrat', Arial, sans-serif;}
    .card { background: linear-gradient(120deg, #0c0a0f 0%, #160f3d 100%);
            border: 1.7px solid #4b4181; border-radius: 1.15rem; margin-bottom: 2.1rem; }
    .gold { color: #8c84ac; }
    .menu-btn { position: fixed; top: 18px; left: 28px; z-index: 50; }
    .logout-absolute { position: fixed; top: 18px; right: 28px; z-index: 50; }
  </style>
</head>
<body>
  <button id="menuBtn" class="menu-btn bg-[#16122f] p-2 rounded-full border border-[#4b4181] hover:bg-[#4b4181]">
    <svg width="30" height="30" fill="none" stroke="#e5e2e4" stroke-width="3" viewBox="0 0 24 24">
      <path stroke-linecap="round" d="M4 7h16M4 12h16M4 17h16"/></svg>
  </button>
  <button id="logoutBtn" class="btn-primary logout-absolute">Logout</button>
  <div class="w-full max-w-lg mx-auto mt-12 p-6">
    <a href="dashboard.html">
      <img src="https://i.postimg.cc/KcLVGFWY/logo6.png" class="logo-img w-20 h-20 rounded-full mx-auto mb-2"/>
      <img src="https://i.postimg.cc/QtFmLjWh/logo8.png" class="title-img max-w-xs mx-auto mb-6"/>
    </a>
    <div class="card p-7">
      <h1 class="text-2xl gold font-bold mb-4">Edit User Details</h1>
      <form id="editUserForm" class="space-y-5">
        <div>
          <label class="block mb-1 text-sm gold">State ID</label>
          <input type="text" id="stateId" class="w-full px-4 py-2 rounded bg-[#1a1a2b]" disabled>
        </div>
        <div>
          <label class="block mb-1 text-sm gold">Full Name</label>
          <input type="text" id="fullName" class="w-full px-4 py-2 rounded bg-[#1a1a2b]" disabled>
        </div>
        <div>
          <label class="block mb-1 text-sm gold">Nickname (optional)</label>
          <input type="text" id="nickname" class="w-full px-4 py-2 rounded bg-[#1a1a2b]">
        </div>
        <div>
          <label class="block mb-1 text-sm gold">Phone Number</label>
          <input type="text" id="phone" class="w-full px-4 py-2 rounded bg-[#1a1a2b]">
        </div>
        <div>
          <label class="block mb-1 text-sm gold">Password</label>
          <input type="password" id="password" class="w-full px-4 py-2 rounded bg-[#1a1a2b]">
        </div>
        <button type="submit" class="btn-primary w-full mt-2">Save Changes</button>
        <div id="editUserMsg" class="mt-2 text-center"></div>
      </form>
    </div>
    <a href="dashboard.html" class="text-blue-300 hover:underline">&larr; Back to Summary</a>
  </div>
  <script>
    const db = supabase.createClient(
      "https://nxgivpbbuwbzjsfbhlzt.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54Z2l2cGJidXdiempzZmJobHp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3ODA2ODYsImV4cCI6MjA2NDM1NjY4Nn0.7Hrn29OfpNGLyOy3tASiuWX6lsWQ3t1mrLWBb2K_E7E"
    );
    const user = JSON.parse(localStorage.getItem("karmaUser")||"{}");
    if (!user.id) window.location.href = "index.html";
    document.getElementById("stateId").value = user.id || "";
    document.getElementById("fullName").value = user.full_name || "";
    document.getElementById("nickname").value = user.nickname || "";
    document.getElementById("phone").value = user.phone || "";
    document.getElementById("password").value = user.password || "";

    document.getElementById("editUserForm").onsubmit = async function(e) {
      e.preventDefault();
      const nickname = document.getElementById("nickname").value;
      const phone = document.getElementById("phone").value;
      const password = document.getElementById("password").value;
      const { data, error } = await db.from("users").update({
        nickname: nickname,
        phone: phone,
        password: password
      }).eq("id", user.id);
      if (!error) {
        // Update localStorage
        user.nickname = nickname; user.phone = phone; user.password = password;
        localStorage.setItem("karmaUser", JSON.stringify(user));
        document.getElementById("editUserMsg").textContent = "Saved!";
        document.getElementById("editUserMsg").className = "text-green-400 mt-2";
      } else {
        document.getElementById("editUserMsg").textContent = "Error updating profile!";
        document.getElementById("editUserMsg").className = "text-pink-300 mt-2";
      }
    };
    document.getElementById('logoutBtn').onclick = function() {
      localStorage.removeItem("karmaUser");
      window.location.href = "index.html";
    };
  </script>
</body>
</html>
